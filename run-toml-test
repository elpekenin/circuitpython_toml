#!/usr/bin/env bash

# TODO?: Run unittest here too?
# WIP: Invalid tests still to be checked
#      Some features might get added while doing so

OUTPUT=toml-test.out

# Run specification tests using toml-test
# https://github.com/toml-lang/toml-test

# NOTE: Tests skipped because a feature is not supported may still be broken
#       after it gets implemented (some other "masked" issue)

skip=(
    # multiline arrays not supported
    -skip 'valid/array/array'
    -skip 'valid/array/mixed-string-table'
    -skip 'valid/array/nested-double'
    -skip 'valid/array/string-quote-comma'
    -skip 'valid/array/string-with-comma'
    -skip 'valid/array/string-with-comma-2'
    -skip 'valid/array/string-quote-comma-2'
    -skip 'valid/array/trailing-comma'
    -skip 'valid/comment/everywhere'
    -skip 'valid/spec/array-0'
    -skip 'valid/spec/array-1'

    # inline tables not supported
    -skip 'valid/array/nested-inline-table'
    -skip 'valid/array/table-array-string-backslash'
    -skip 'valid/inline-table/array'
    -skip 'valid/inline-table/array-values'
    -skip 'valid/inline-table/bool'
    -skip 'valid/inline-table/empty'
    -skip 'valid/inline-table/end-in-bool'
    -skip 'valid/inline-table/inline-table'
    -skip 'valid/inline-table/key-dotted-1'
    -skip 'valid/inline-table/key-dotted-2'
    -skip 'valid/inline-table/key-dotted-3'
    -skip 'valid/inline-table/key-dotted-4'
    -skip 'valid/inline-table/key-dotted-5'
    -skip 'valid/inline-table/key-dotted-6'
    -skip 'valid/inline-table/key-dotted-7'
    -skip 'valid/inline-table/multiline'
    -skip 'valid/inline-table/nest'
    -skip 'valid/inline-table/spaces'
    -skip 'valid/key/start'
    -skip 'valid/spec/inline-table-0'
    -skip 'valid/spec/inline-table-2'

    # inf/nan not supported
    -skip 'valid/comment/after-literal-no-ws'
    -skip 'valid/float/inf-and-nan'
    -skip 'valid/spec/float-2'

    # datetime not supported
    -skip 'valid/datetime/datetime'
    -skip 'valid/datetime/edge'
    -skip 'valid/datetime/leap-year'
    -skip 'valid/datetime/local'
    -skip 'valid/datetime/local-date'
    -skip 'valid/datetime/local-time'
    -skip 'valid/datetime/milliseconds'
    -skip 'valid/datetime/timezone'
    -skip 'valid/example'
    -skip 'valid/spec-example-1'
    -skip 'valid/spec-example-1-compact'
    -skip 'valid/spec/local-date-0'
    -skip 'valid/spec/local-date-time-0'
    -skip 'valid/spec/local-time-0'
    -skip 'valid/spec/offset-date-time-0'
    -skip 'valid/spec/offset-date-time-1'
    -skip 'valid/spec/table-7'

    # exponents not supported
    -skip 'valid/float/exponent'
    -skip 'valid/float/zero'
    -skip 'valid/spec/float-0'

    # numbers with underscores not supported
    -skip 'valid/float/max-int'
    -skip 'valid/float/underscore'
    -skip 'valid/integer/float64-max'
    -skip 'valid/integer/underscore'
    -skip 'valid/spec/float-1'
    -skip 'valid/spec/integer-1'

    # [[implicit-array]] (or whatever this is called) not supported
    -skip 'valid/array/array-subtables'
    -skip 'valid/array/open-parent-table'
    -skip 'valid/key/dotted-4'
    -skip 'valid/spec/array-of-tables-0'
    -skip 'valid/spec/array-of-tables-1'
    -skip 'valid/spec/array-of-tables-2'
    -skip 'valid/table/array-implicit'
    -skip 'valid/table/array-implicit-and-explicit-after'
    -skip 'valid/table/array-many'
    -skip 'valid/table/array-nest'
    -skip 'valid/table/array-one'
    -skip 'valid/table/array-table-array'
    -skip 'valid/table/array-within-dotted'

    # handling of strings is tricky
    #   - triple quotes
    #   - unicode
    #   - escape sequences
    #   - "quoted.key" is implicitly converted to table instead of dotted key
    -skip 'valid/comment/tricky'
    -skip 'valid/spec/string-1'
    -skip 'valid/spec/string-3'
    -skip 'valid/key/escapes'
    -skip 'valid/key/quoted-unicode'
    -skip 'valid/key/space'
    -skip 'valid/spec/keys-1'
    -skip 'valid/spec/keys-3'
    -skip 'valid/spec/string-0'
    -skip 'valid/spec/string-2'
    -skip 'valid/spec/string-4'
    -skip 'valid/spec/string-6'
    -skip 'valid/spec/table-2'
    -skip 'valid/string/ends-in-whitespace-escape'
    -skip 'valid/string/multiline'
    -skip 'valid/string/multiline-empty'
    -skip 'valid/string/multiline-escaped-crlf'
    -skip 'valid/string/multiline-quotes'
    -skip 'valid/string/raw-multiline'
    -skip 'valid/string/start-mb'
    -skip 'valid/string/unicode-escape'
    -skip 'valid/string/escape-tricky'
    -skip 'valid/string/escaped-escape'
    -skip 'valid/string/escapes'
    -skip 'valid/string/nl'
    -skip 'valid/string/quoted-unicode'

    # we do not eagerly create empty tables
    -skip 'valid/spec/table-0'
    -skip 'valid/spec/table-3'
    -skip 'valid/spec/table-4'
    -skip 'valid/spec/table-5'
    -skip 'valid/spec/table-6'
    -skip 'valid/table/empty'

    # =====
    # TODO: Check these

    # -skip 'invalid/array/double-comma-1'
    # -skip 'invalid/array/double-comma-2'
    # -skip 'invalid/array/extend-defined-aot'
    # -skip 'invalid/array/only-comma-1'
    # -skip 'invalid/array/only-comma-2'
    # -skip 'invalid/array/tables-1'
    # -skip 'invalid/array/tables-2'
    # -skip 'invalid/control/bare-cr'
    # -skip 'invalid/control/comment-cr'
    # -skip 'invalid/control/comment-del'
    # -skip 'invalid/control/comment-ff'
    # -skip 'invalid/control/comment-lf'
    # -skip 'invalid/control/comment-null'
    # -skip 'invalid/control/comment-us'
    # -skip 'invalid/control/multi-cr'
    # -skip 'invalid/control/multi-del'
    # -skip 'invalid/control/multi-lf'
    # -skip 'invalid/control/multi-null'
    # -skip 'invalid/control/multi-us'
    # -skip 'invalid/control/rawmulti-cd'
    # -skip 'invalid/control/rawmulti-del'
    # -skip 'invalid/control/rawmulti-lf'
    # -skip 'invalid/control/rawmulti-null'
    # -skip 'invalid/control/rawmulti-us'
    # -skip 'invalid/control/rawstring-cr'
    # -skip 'invalid/control/rawstring-del'
    # -skip 'invalid/control/rawstring-lf'
    # -skip 'invalid/control/rawstring-null'
    # -skip 'invalid/control/rawstring-us'
    # -skip 'invalid/control/string-bs'
    # -skip 'invalid/control/string-cr'
    # -skip 'invalid/control/string-del'
    # -skip 'invalid/control/string-lf'
    # -skip 'invalid/control/string-null'
    # -skip 'invalid/control/string-us'
    # -skip 'invalid/encoding/bad-codepoint'
    # -skip 'invalid/encoding/bad-utf8-in-comment'
    # -skip 'invalid/encoding/bad-utf8-in-multiline'
    # -skip 'invalid/encoding/bad-utf8-in-multiline-literal'
    # -skip 'invalid/encoding/bad-utf8-in-string'
    # -skip 'invalid/encoding/bad-utf8-in-string-literal'
    # -skip 'invalid/float/leading-point'
    # -skip 'invalid/float/leading-point-neg'
    # -skip 'invalid/float/leading-zero'
    # -skip 'invalid/float/leading-zero-neg'
    # -skip 'invalid/float/trailing-point'
    # -skip 'invalid/float/trailing-point-min'
    # -skip 'invalid/integer/capital-bin'
    # -skip 'invalid/integer/capital-hex'
    # -skip 'invalid/integer/capital-oct'
    # -skip 'invalid/integer/leading-zero-1'
    # -skip 'invalid/integer/leading-zero-2'
    # -skip 'invalid/integer/leading-zero-3'
    # -skip 'invalid/integer/leading-zero-sign-1'
    # -skip 'invalid/integer/us-after-bin'
    # -skip 'invalid/integer/us-after-hex'
    # -skip 'invalid/integer/us-after-oct'
    # -skip 'invalid/key/after-array'
    # -skip 'invalid/key/after-table'
    # -skip 'invalid/key/after-value'
    # -skip 'invalid/key/bare-invalid-character'
    # -skip 'invalid/key/duplicate-keys-1'
    # -skip 'invalid/key/duplicate-keys-2'
    # -skip 'invalid/key/duplicate-keys-3'
    # -skip 'invalid/key/duplicate-keys-4'
    # -skip 'invalid/key/empty'
    # -skip 'invalid/key/escape'
    # -skip 'invalid/key/open-bracket'
    # -skip 'invalid/key/partial-quoted'
    # -skip 'invalid/key/space'
    # -skip 'invalid/key/special-character'
    # -skip 'invalid/key/start-bracket'
    # -skip 'invalid/key/start-dot'
    # -skip 'invalid/spec/keys-2'
    # -skip 'invalid/string/bad-byte-escape'
    # -skip 'invalid/string/bad-concat'
    # -skip 'invalid/string/bad-escape-1'
    # -skip 'invalid/string/bad-escape-2'
    # -skip 'invalid/string/bad-escape-3'
    # -skip 'invalid/string/bad-hex-esc-1'
    # -skip 'invalid/string/bad-hex-esc-2'
    # -skip 'invalid/string/bad-hex-esc-3'
    # -skip 'invalid/string/bad-hex-esc-4'
    # -skip 'invalid/string/bad-hex-esc-5'
    # -skip 'invalid/string/bad-slash-escape'
    # -skip 'invalid/string/bad-uni-esc-1'
    # -skip 'invalid/string/bad-uni-esc-2'
    # -skip 'invalid/string/bad-uni-esc-3'
    # -skip 'invalid/string/bad-uni-esc-4'
    # -skip 'invalid/string/bad-uni-esc-5'
    # -skip 'invalid/string/bad-uni-esc-6'
    # -skip 'invalid/string/bad-uni-esc-7'
    # -skip 'invalid/string/basic-byte-escapes'
    # -skip 'invalid/string/basic-multiline-out-of-range-unicode-escape-1'
    # -skip 'invalid/string/basic-multiline-out-of-range-unicode-escape-2'
    # -skip 'invalid/string/basic-multiline-unknown-escape'
    # -skip 'invalid/string/basic-out-of-range-unicode-escape-1'
    # -skip 'invalid/string/basic-out-of-range-unicode-escape-2'
    # -skip 'invalid/string/basic-unknown-escape'
    # -skip 'invalid/string/multiline-bad-escape-1'
    # -skip 'invalid/string/multiline-bad-escape-2'
    # -skip 'invalid/string/multiline-bad-escape-3'
    # -skip 'invalid/string/multiline-bad-escape-4'
    # -skip 'invalid/table/append-to-array-with-dotted-keys'
    # -skip 'invalid/table/append-with-dotted-keys-1'
    # -skip 'invalid/table/append-with-dotted-keys-2'
    # -skip 'invalid/table/array-empty'
    # -skip 'invalid/table/array-implicit'
    # -skip 'invalid/table/array-no-close-1'
    # -skip 'invalid/table/array-no-close-2'
    # -skip 'invalid/table/duplicate'
    # -skip 'invalid/table/duplicate-key-dotted-array'
    # -skip 'invalid/table/duplicate-table-array'
    # -skip 'invalid/table/duplicate-table-array2'
    # -skip 'invalid/table/empty'
    # -skip 'invalid/table/empty-implicit-table'
    # -skip 'invalid/table/nested-brackets-close'
    # -skip 'invalid/table/nested-brackets-open'
    # -skip 'invalid/table/overwrite-array-in-parent'
    # -skip 'invalid/table/overwrite-bool-with-array'
    # -skip 'invalid/table/overwrite-with-deep-table'
    # -skip 'invalid/table/super-twice'
)

if [[ "$1" == noskip ]]
then
    skip=(-print-skip)
fi

THIS=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
toml-test -color never ${skip[@]} ${THIS}/toml-test-decoder > ${OUTPUT} 2>&1